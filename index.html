<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krishi Mitra - Crop Advisory Chatbot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --primary: #4caf50;
            --secondary: #388e3c;
            --accent: #8bc34a;
            --light: #f1f8e9;
            --dark: #1b5e20;
            --text: #212121;
            --text-light: #757575;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --chatbot-bg: #f5f5f5;
            --user-msg: #e3f2fd;
            --bot-msg: #f5f5f5;
        }
        body {
            background-color: #f9f9f9;
            color: var(--text);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: var(--white);
            padding: 15px 0;
            box-shadow: var(--shadow);
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 24px;
        }

        .logo h1 {
            font-size: 22px;
            font-weight: 600;
        }

        .main-content {
            display: none;
            flex: 1;
            gap: 20px;
            padding: 30px 0;
        }
        
        .options-panel {
            flex: 0 0 300px;
            background: var(--white);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .options-panel h2 {
            color: var(--dark);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent);
        }

        .option-card {
            background: var(--light);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-card:hover {
            background: var(--accent);
            color: var(--white);
        }

        .option-card i {
            margin-right: 10px;
            font-size: 18px;
        }

        .chatbot-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--white);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow);
            height: 100%;
            max-height: calc(100vh - 150px);
        }

        .chat-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: var(--white);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header .status {
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #4caf50;
            border-radius: 50%;
            margin-right: 5px;
        }

        .chat-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--chatbot-bg);
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: calc(100vh - 250px);
            max-height: 600px;
        }

        .message {
            max-width: 80%;
            padding: 12px 15px;
            border-radius: 18px;
            line-height: 1.4;
        }

        .user-message {
            align-self: flex-end;
            background: var(--primary);
            color: var(--white);
            border-bottom-right-radius: 5px;
        }

        .bot-message {
            align-self: flex-start;
            background: var(--bot-msg);
            color: var(--text);
            border-bottom-left-radius: 5px;
            box-shadow: var(--shadow);
        }
        
        .market-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            width: 100%;
        }

        .market-option {
            background-color: var(--light);
            border: 1px solid var(--accent);
            color: var(--dark);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }

        .market-option:hover {
            background-color: var(--accent);
            color: var(--white);
        }

        .soil-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            width: 100%;
        }

        .soil-option {
            background-color: var(--light);
            border: 1px solid var(--accent);
            color: var(--dark);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }

        .soil-option:hover {
            background-color: var(--accent);
            color: var(--white);
        }


        .chat-input {
            display: flex;
            padding: 15px;
            background: var(--white);
            border-top: 1px solid #e0e0e0;
            position: relative;
            bottom: 0;
            z-index: 900;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 30px;
            outline: none;
            font-size: 16px;
        }

        .chat-input button {
            background: var(--primary);
            color: var(--white);
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-left: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .chat-input button:hover {
            background: var(--secondary);
        }

        .language-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .language-selector select {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            outline: none;
        }

        .voice-input {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }

        .voice-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .voice-btn:hover {
            background: var(--secondary);
        }
        
        .voice-btn.active {
            background: #d32f2f;
        }

        footer {
            background: var(--dark);
            color: var(--white);
            padding: 20px 0;
            text-align: center;
        }

        .intro-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            flex: 1;
            padding: 40px;
            background: var(--white);
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin: 50px auto;
            max-width: 600px;
        }

        .intro-screen h2 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .intro-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .intro-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            text-align: left;
        }

        .intro-form input, .intro-form select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
        }

        .intro-form button {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .intro-form button:hover {
            background: var(--secondary);
        }
        
        .location-status {
            margin-top: 10px;
            font-style: italic;
            color: var(--text-light);
        }
        
        .bot-message p {
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .options-panel {
                flex: 0 0 auto;
                margin-bottom: 20px;
            }
            
            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-seedling"></i>
                    <h1>Krishi Mitra - Crop Advisory Chatbot</h1>
                </div>
            </div>
        </div>
    </header>

    <div class="intro-screen" id="introScreen">
        <div class="logo">
            <i class="fas fa-seedling" style="font-size: 40px; color: var(--primary);"></i>
            <h2 style="font-size: 28px;">Welcome to Krishi Mitra!</h2>
        </div>
        <p>Please select your preferred language. We will try to automatically detect your location.</p>
        <div class="intro-form">
            <div>
                <label for="initialLanguage">Select your Language:</label>
                <select id="initialLanguage">
                    <option value="en">English</option>
                    <option value="hi">Hindi</option>
                    <option value="ta">Tamil</option>
                    <option value="te">Telugu</option>
                    <option value="bn">Bengali</option>
                </select>
            </div>
            <div id="locationInputContainer" style="display: none;">
                <label for="initialLocation">Enter your Location (e.g., city or district):</label>
                <input type="text" id="initialLocation" placeholder="e.g., Bhopal, Madhya Pradesh">
            </div>
            <div class="location-status" id="locationStatus">
                Detecting your location...
            </div>
            <button onclick="startChat()" id="startButton" style="display: none;">Start Chat</button>
        </div>
    </div>

    <div class="container main-content" id="mainContent">
        <div class="options-panel">
            <h2 id="optionsTitle">Quick Advisory Options</h2>
            <div class="option-card" onclick="selectOption('crop-selection')">
                <i class="fas fa-seedling"></i> <span class="option-text">Crop Selection Advice</span>
            </div>
            <div class="option-card" onclick="selectOption('pest-control')">
                <i class="fas fa-bug"></i> <span class="option-text">Pest Control Advice</span>
            </div>
            <div class="option-card" onclick="selectOption('fertilizer')">
                <i class="fas fa-flask"></i> <span class="option-text">Fertilizer Guidance</span>
            </div>
            <div class="option-card" onclick="selectOption('weather')">
                <i class="fas fa-cloud-sun"></i> <span class="option-text">Weather Advisory</span>
            </div>
            <div class="option-card" onclick="selectOption('soil-health')">
                <i class="fas fa-tint"></i> <span class="option-text">Soil Health Tips</span>
            </div>
            <div class="option-card" onclick="selectOption('market-prices')">
                <i class="fas fa-rupee-sign"></i> <span class="option-text">Market Prices</span>
            </div>
            
            <div class="language-selector">
                <span><i class="fas fa-language"></i> Language:</span>
                <select id="languageSelect" onchange="changeLanguage()">
                    <option value="en">English</option>
                    <option value="hi">Hindi</option>
                    <option value="ta">Tamil</option>
                    <option value="te">Telugu</option>
                    <option value="bn">Bengali</option>
                </select>
            </div>
            
            <div class="voice-input">
                <button class="voice-btn" onclick="toggleVoiceInput()" id="voiceBtn">
                    <i class="fas fa-microphone"></i> <span id="voiceBtnText">Voice Input</span>
                </button>
            </div>
        </div>

        <div class="chatbot-container">
            <div class="chat-header">
                <h2><i class="fas fa-robot"></i> Krishi Mitra Assistant</h2>
                <div class="status">
                    <span class="status-dot"></span>
                    <span>Online</span>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
            </div>
            
            <div class="chat-input">
                <input type="text" id="userInput" placeholder="Type your message here..." onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2023 Krishi Mitra - Smart Crop Advisory System for Small and Marginal Farmers</p>
        </div>
    </footer>

    <script>
        // API KEY FOR OPENWEATHERMAP
        const OPENWEATHER_API_KEY = "00e57a66081e7510a54ec6f575e31b2b";
        
        // API KEY FOR OGD
        const OGD_API_KEY = "579b464db66ec23bdd000001cdd3946e44ce4aad7209ff7b23ac571b";
        
        let userLocation = "";
        let userState = "";
        let userDistrict = "";
        let userLanguage = "en";
        let userLat = null;
        let userLon = null;
        let isAwaitingSoilType = false;
        let isAwaitingCropName = false;

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        let isListening = false;
        
        if (recognition) {
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('userInput').value = transcript;
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('active');
                document.getElementById('voiceBtnText').textContent = 'Voice Input';
                sendMessage();
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('active');
                document.getElementById('voiceBtnText').textContent = 'Error. Try again';
            };

            recognition.onend = () => {
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('active');
                document.getElementById('voiceBtnText').textContent = 'Voice Input';
            };
        } else {
            console.warn('Web Speech API is not supported in this browser.');
            document.getElementById('voiceBtn').style.display = 'none';
        }

        const translations = {
            "en": {
                "greeting": "Hello! I'm Krishi Mitra, your crop advisory assistant. How can I help you today?",
                "personalized_welcome": "Welcome from {location}! I can provide personalized advice on crop selection, pest control, fertilizer use, weather forecasts, and market prices. How can I help you?",
                "crop-selection": "What is your soil type? This helps me suggest the best crops for your land.",
                "pest-control": "For natural pest control, consider neem-based pesticides or companion planting. Could you describe the pest problem in more detail?",
                "fertilizer": "Organic fertilizers like compost and vermicompost are recommended for your soil type. How many acres are you planning to fertilize?",
                "weather": "Here is the live weather report for your location:",
                "soil-health": "Based on your location, your soil might benefit from adding organic matter. Have you tested your soil pH recently?",
                "market-prices": "Which crop's price would you like to check?",
                "default": "I'm sorry, I didn't understand that. Could you please rephrase or ask about crop selection, pest control, fertilizers, weather, or market prices?",
                "options_title": "Quick Advisory Options",
                "crop-selection-query": "Crop Selection Advice",
                "pest-control-query": "Pest Control Advice",
                "fertilizer-query": "Fertilizer Guidance",
                "weather-query": "Weather Advisory",
                "soil-health-query": "Soil Health Tips",
                "market-prices-query": "Market Prices",
                "soil-types": {
                    "question": "What is your soil type? Select one from the list below.",
                    "options": ["Alluvial Soil", "Black Soil", "Red Soil", "Laterite Soil", "Arid Soil", "Forest Soil"]
                },
                "crops_for_alluvial": "Alluvial soil is the most fertile. Based on your location, I recommend growing crops like **wheat**, **rice**, **sugarcane**, and **jute**. What crop are you interested in?",
                "crops_for_black": "Black soil is great for moisture retention. In your location, crops like **cotton**, **soybean**, **jowar**, and **wheat** are well-suited. Are you considering any of these?",
                "crops_for_red": "For your red soil, crops that do well are those that can tolerate low fertility, such as **groundnuts**, **pulses**, and **millets**. Do any of these sound like a good fit?",
                "crops_for_laterite": "Laterite soil is often used for plantation crops. I recommend growing **tea**, **coffee**, and **spices** like cardamom or cashews. What would you like to know more about?",
                "crops_for_arid": "Arid soil is sandy. With proper irrigation, crops like **bajra**, **barley**, and **dates** can be grown successfully. Are you interested in any of these?",
                "crops_for_forest": "Forest soil is rich in humus. In your location, I recommend growing **fruits**, **tea**, and medicinal plants. Which of these would you like to know more about?",
                "no_soil_type": "Please select a soil type from the options provided to get a specific crop recommendation.",
                "weather_report": "<b>Weather in {location}:</b><br>Temperature: {temp}°C<br>Condition: {description}<br>Humidity: {humidity}%<br>Wind Speed: {wind} m/s",
                "weather_error": "Sorry, I couldn't get the weather for your location right now. Please try again later.",
                "price_report": "<b>Live Market Prices for {crop} in {district}, {state}:</b><br>Modal Price: ₹{modal} per Quintal<br>Minimum Price: ₹{min} per Quintal<br>Maximum Price: ₹{max} per Quintal<br><i>(Prices are from {date}, {market})</i>",
                "price_error": "Sorry, I couldn't find live market prices for {crop} in your region. Prices might not be available or the name of the crop is incorrect. Please try a different crop or check again later.",
                "ask_crop_price": "Which crop's price would you like to check? (e.g., Rice, Wheat, Cotton)",
                "price_unavailable": "Market prices are not available for your location or the selected crop. Please try a different location or crop.",
                "not_indian_location": "I am sorry, Krishi Mitra is currently only available for locations within India. We could not find a state or district for your location."
            },
            "hi": {
                "greeting": "नमस्ते! मैं कृषि मित्र हूँ, आपका फसल सलाहकार सहायक। आज मैं आपकी क्या मदद कर सकता हूँ?",
                "personalized_welcome": "{location} से आपका स्वागत है! मैं आपको फसल चयन, कीट नियंत्रण, उर्वरक उपयोग, मौसम पूर्वानुमान और बाजार कीमतों पर व्यक्तिगत सलाह दे सकता हूँ। मैं आपकी कैसे मदद करूँ?",
                "crop-selection": "आपकी मिट्टी का प्रकार क्या है? इससे मुझे आपकी जमीन के लिए सबसे अच्छी फसलें सुझाने में मदद मिलती है।",
                "pest-control": "प्राकृतिक कीट नियंत्रण के लिए, नीम-आधारित कीटनाशकों या साथी रोपण पर विचार करें। क्या आप कीट की समस्या का अधिक विस्तार से वर्णन कर सकते हैं?",
                "fertilizer": "आपकी मिट्टी के प्रकार के लिए कम्पोस्ट और वर्मीकम्पोस्ट जैसे जैविक उर्वरकों की सिफारिश की जाती है। आप कितने एकड़ में खाद डालने की योजना बना रहे हैं?",
                "weather": "आपके स्थान के लिए लाइव मौसम रिपोर्ट यहाँ है:",
                "soil-health": "आपके स्थान के आधार पर, आपकी मिट्टी को जैविक पदार्थ जोड़ने से लाभ हो सकता है। क्या आपने हाल ही में अपनी मिट्टी का पीएच परीक्षण किया है?",
                "market-prices": "आप किस फसल की कीमत जानना चाहेंगे?",
                "default": "मुझे माफ़ करना, मैं समझ नहीं पाया। क्या आप कृपया इसे दोबारा कह सकते हैं या फसल चयन, कीट नियंत्रण, उर्वरक, मौसम या बाजार कीमतों के बारे में पूछ सकते हैं?",
                "options_title": "त्वरित सलाह विकल्प",
                "crop-selection-query": "फसल चयन पर सलाह",
                "pest-control-query": "कीट नियंत्रण पर सलाह",
                "fertilizer-query": "उर्वरक मार्गदर्शन",
                "weather-query": "मौसम सलाहकार",
                "soil-health-query": "मिट्टी स्वास्थ्य युक्तियाँ",
                "market-prices-query": "बाजार मूल्य",
                "soil-types": {
                    "question": "आपकी मिट्टी का प्रकार क्या है? नीचे दी गई सूची से एक का चयन करें।",
                    "options": ["जलोढ़ मिट्टी", "काली मिट्टी", "लाल मिट्टी", "लैटेराइट मिट्टी", "शुष्क मिट्टी", "वन मिट्टी"]
                },
                "crops_for_alluvial": "जलोढ़ मिट्टी सबसे उपजाऊ है। आपके स्थान के आधार पर, मैं **गेहूं**, **चावल**, **गन्ना**, और **जूट** जैसी फसलें उगाने की सलाह देता हूँ। आप किस फसल में रुचि रखते हैं?",
                "crops_for_black": "काली मिट्टी पानी को बनाए रखने के लिए बहुत अच्छी है। आपके स्थान में, **कपास**, **सोयाबीन**, **ज्वार**, और **गेहूं** जैसी फसलें अच्छी होती हैं। क्या आप इनमें से किसी पर विचार कर रहे हैं?",
                "crops_for_red": "आपकी लाल मिट्टी के लिए, जो फसलें अच्छा करती हैं वे हैं जो कम उर्वरता को सहन कर सकती हैं, जैसे **मूंगफली**, **দालें**, और **बाजरा**। क्या इनमें से कोई आपके लिए उपयुक्त है?",
                "crops_for_laterite": "लैटेराइट मिट्टी का उपयोग अक्सर बागान फसलों के लिए किया जाता है। मैं **चाय**, **कॉफी**, और **मसाला** जैसे इलायची या काजू उगाने की सलाह देता हूँ। आप किसके बारे में अधिक जानना चाहेंगे?",
                "crops_for_arid": "शुष्क मिट्टी रेतीली होती है। उचित सिंचाई के साथ, **बाजरा**, **जौ**, और **खजूर** जैसी फसलें सफलतापूर्वक उगाई जा सकती हैं। क्या आप इनमें से किसी में रुचि रखते हैं?",
                "crops_for_forest": "वन मिट्टी ह्यूमस से भरपूर होती है। आपके स्थान में, मैं **फल**, **चाय**, और औषधीय पौधे उगाने की सलाह देता हूँ। आप इनमें से किसके बारे में अधिक जानना चाहेंगे?",
                "no_soil_type": "कृपया विशिष्ट फसल की सिफारिश प्राप्त करने के लिए दिए गए विकल्पों में से एक मिट्टी का प्रकार चुनें।",
                "weather_report": "<b>{location} में मौसम:</b><br>तापमान: {temp}°C<br>स्थिति: {description}<br>आर्द्रता: {humidity}%<br>हवा की गति: {wind} m/s",
                "weather_error": "क्षमा करें, मैं अभी आपके स्थान के लिए मौसम प्राप्त नहीं कर सका। कृपया बाद में पुनः प्रयास करें।",
                "price_report": "<b>{district}, {state} में {crop} के लिए लाइव बाजार मूल्य:</b><br>मोडल मूल्य: ₹{modal} प्रति क्विंटल<br>न्यूनतम मूल्य: ₹{min} प्रति क्विंटल<br>अधिकतम मूल्य: ₹{max} प्रति क्विंटल<br><i>(कीमतें {date}, {market} से हैं)</i>",
                "price_error": "क्षमा करें, मुझे आपके क्षेत्र में {crop} के लिए लाइव बाजार मूल्य नहीं मिल सके। कीमतें उपलब्ध नहीं हो सकती हैं या फसल का नाम गलत है। कृपया कोई अन्य फसल आज़माएँ या बाद में दोबारा जाँच करें।",
                "ask_crop_price": "आप किस फसल की कीमत जानना चाहेंगे? (उदा. चावल, गेहूं, कपास)",
                "price_unavailable": "आपके स्थान या चयनित फसल के लिए बाजार मूल्य उपलब्ध नहीं हैं। कृपया कोई अन्य स्थान या फसल आज़माएँ।",
                "not_indian_location": "मुझे खेद है, कृषि मित्र वर्तमान में केवल भारत के भीतर के स्थानों के लिए उपलब्ध है। हम आपके स्थान के लिए राज्य या जिला नहीं ढूंढ पाए।"
            },
            "te": {
                "greeting": "హలో! నేను కృషి మిత్ర, మీ పంట సలహా సహాయకుడు. ఈ రోజు నేను మీకు ఎలా సహాయం చేయగలను?",
                "personalized_welcome": "{location} నుండి స్వాగతం! నేను పంట ఎంపిక, తెగుళ్ళ నియంత్రణ, ఎరువుల వాడకం, వాతావరణ అంచనాలు మరియు మార్కెట్ ధరలపై వ్యక్తిగత సలహా ఇవ్వగలను. నేను మీకు ఎలా సహాయం చేయగలను?",
                "crop-selection": "మీ నేల రకం ఏమిటి? ఇది మీ భూమికి ఉత్తమ పంటలను సూచించడానికి నాకు సహాయపడుతుంది.",
                "pest-control": "సహజ తెగుళ్ళ నియంత్రణ కోసం, వేప ఆధారిత పురుగుమందులు లేదా సహచర మొక్కల పెంపకం గురించి ఆలోచించండి. మీరు తెగులు సమస్యను మరింత వివరంగా వివరించగలరా?",
                "fertilizer": "సేంద్రీయ ఎరువులు, కంపోస్ట్ మరియు వర్మికంపోస్ట్ మీ నేల రకానికి సిఫార్సు చేయబడతాయి. మీరు ఎన్ని ఎకరాలకు ఎరువు వేయడానికి ప్రణాళిక వేస్తున్నారు?",
                "weather": "మీ ప్రదేశానికి ప్రత్యక్ష వాతావరణ నివేదిక ఇక్కడ ఉంది:",
                "soil-health": "మీ ప్రదేశం ఆధారంగా, మీ నేల సేంద్రీయ పదార్థాన్ని జోడించడం ద్వారా ప్రయోజనం పొందవచ్చు. మీరు ఇటీవల మీ నేల pH ని పరీక్షించారా?",
                "market-prices": "మీరు ఏ పంట ధరను తనిఖీ చేయాలనుకుంటున్నారు?",
                "default": "క్షమించండి, నాకు అర్థం కాలేదు. దయచేసి మళ్ళీ చెప్పగలరా లేదా పంట ఎంపిక, తెగుళ్ళ నియంత్రణ, ఎరువులు, వాతావరణం లేదా మార్కెట్ ధరల గురించి అడగగలరా?",
                "options_title": "త్వరిత సలహా ఎంపికలు",
                "crop-selection-query": "పంట ఎంపిక సలహా",
                "pest-control-query": "తెగుళ్ళ నియంత్రణ సలహా",
                "fertilizer-query": "ఎరువుల మార్గదర్శకం",
                "weather-query": "వాతావరణ సలహా",
                "soil-health-query": "నేల ఆరోగ్య చిట్కాలు",
                "market-prices-query": "మార్కెట్ ధరలు",
                "soil-types": {
                    "question": "మీ నేల రకం ఏమిటి? క్రింది జాబితా నుండి ఒకదానిని ఎంచుకోండి。",
                    "options": ["ఒండ్రు నేల", "నల్ల నేల", "ఎర్ర నేల", "లాటరైట్ నేల", "శుష్క నేల", "అటవీ నేల"]
                },
                "crops_for_alluvial": "ఒండ్రు నేల అత్యంత సారవంతమైనది. మీ ప్రదేశం ఆధారంగా, నేను **గోధుమ**, **వరి**, **చెరకు**, మరియు **జూట్** వంటి పంటలను పెంచమని సిఫార్సు చేస్తున్నాను. మీకు ఏ పంటపై ఆసక్తి ఉంది?",
                "crops_for_black": "నల్ల నేల తేమ నిలుపుకోవడానికి చాలా బాగుంటుంది. మీ ప్రదేశంలో, **పత్తి**, **సోయాబీన్**, **జొన్న**, మరియు **గోధుమ** వంటి పంటలు బాగా సరిపోతాయి. మీరు వీటిలో దేనినైనా పరిశీలిస్తున్నారా?",
                "crops_for_red": "మీ ఎర్ర నేల కోసం, తక్కువ సారవంతమైన నేలను తట్టుకోగల పంటలు, అంటే **వేరుశెనగ**, **పప్పులు**, మరియు **తృణధాన్యాలు** బాగా పెరుగుతాయి. వీటిలో ఏదైనా మీకు సరిపోతుందా?",
                "crops_for_laterite": "లాటరైట్ నేల తరచుగా తోటల పంటలకు ఉపయోగించబడుతుంది. నేను **టీ**, **కాఫీ**, మరియు యాలకులు లేదా జీడిపప్పు వంటి **మసాలా దినుసులు** పెంచమని సిఫార్సు చేస్తున్నాను. మీరు దేని గురించి మరింత తెలుసుకోవాలనుకుంటున్నారు?",
                "crops_for_arid": "శుష్క నేల ఇసుకతో ఉంటుంది. సరైన నీటిపారుదల సహాయంతో, **సజ్జ**, **బార్లీ**, మరియు **ఖర్జూర** వంటి పంటలను విజయవంతంగా పండించవచ్చు. మీరు వీటిలో దేనినైనా ఆసక్తి చూపుతున్నారా?",
                "crops_for_forest": "అటవీ నేల హ్యూమస్‌తో సమృద్ధిగా ఉంటుంది. మీ ప్రదేశంలో, నేను **పండ్లు**, **టీ**, మరియు ఔషధ మొక్కలను పెంచమని సిఫార్సు చేస్తున్నాను. వీటిలో దేని గురించి మీరు మరింత తెలుసుకోవాలనుకుంటున్నారు?",
                "no_soil_type": "నిర్దిష్ట పంట సిఫార్సు పొందడానికి దయచేసి అందించిన ఎంపికల నుండి ఒక నేల రకాన్ని ఎంచుకోండి。",
                "weather_report": "<b>{location}లో వాతావరణం:</b><br>ఉష్ణోగ్రత: {temp}°C<br>పరిస్థితి: {description}<br>తేమ: {humidity}%<br>గాలి వేగం: {wind} m/s",
                "weather_error": "క్షమించండి, మీ ప్రదేశానికి వాతావరణాన్ని నేను ఇప్పుడు పొందలేకపోయాను. దయచేసి తర్వాత మళ్ళీ ప్రయత్నించండి。",
                "price_report": "<b>{district}, {state}లో {crop}కి ప్రత్యక్ష మార్కెట్ ధరలు:</b><br>మోడల్ ధర: క్వింటాల్‌కు ₹{modal}<br>కనీస ధర: క్వింటాల్‌కు ₹{min}<br>గరిష్ట ధర: క్వింటాల్‌కు ₹{max}<br><i>(ధరలు {date}, {market} నుండి)</i>",
                "price_error": "క్షమించండి, మీ ప్రాంతంలో {crop}కి ప్రత్యక్ష మార్కెట్ ధరలు నాకు దొరకలేదు. ధరలు అందుబాటులో లేకపోవచ్చు లేదా పంట పేరు తప్పుగా ఉండవచ్చు. దయచేసి మరొక పంటను ప్రయత్నించండి లేదా తర్వాత మళ్ళీ తనిఖీ చేయండి。",
                "ask_crop_price": "మీరు ఏ పంట ధరను తనిఖీ చేయాలనుకుంటున్నారు? (ఉదా. వరి, గోధుమ, పత్తి)",
                "price_unavailable": "మీ ప్రదేశం లేదా ఎంచుకున్న పంట కోసం మార్కెట్ ధరలు అందుబాటులో లేవు. దయచేసి మరొక ప్రదేశం లేదా పంటను ప్రయత్నించండి。",
                "not_indian_location": "క్షమించండి, కృషి మిత్ర ప్రస్తుతం భారతదేశంలోని ప్రదేశాలకు మాత్రమే అందుబాటులో ఉంది. మేము మీ ప్రదేశం కోసం ఒక రాష్ట్రం లేదా జిల్లాను కనుగొనలేకపోయాము。"
            },
            "bn": {
                "greeting": "নমস্কার! আমি কৃষি মিত্র, আপনার শস্য উপদেষ্টা সহকারী। আজ আমি আপনাকে কিভাবে সাহায্য করতে পারি?",
                "personalized_welcome": "{location} থেকে স্বাগতম! আমি শস্য নির্বাচন, কীটপতঙ্গ নিয়ন্ত্রণ, সার ব্যবহার, আবহাওয়ার পূর্বাভাস এবং বাজার মূল্য সম্পর্কে ব্যক্তিগত পরামর্শ দিতে পারি। আমি আপনাকে কিভাবে সাহায্য করতে পারি?",
                "crop-selection": "আপনার মাটির ধরণ কি? এটি আমাকে আপনার জমির জন্য সেরা শস্যের পরামর্শ দিতে সাহায্য করবে।",
                "pest-control": "প্রাকৃতিক কীটপতঙ্গ নিয়ন্ত্রণের জন্য, নিম-ভিত্তিক কীটনাশক বা সহচর রোপণের কথা ভাবুন। আপনি কি কীটপতঙ্গের সমস্যাটি আরও বিস্তারিতভাবে বর্ণনা করতে পারেন?",
                "fertilizer": "আপনার মাটির ধরণের জন্য জৈব সার যেমন কম্পোস্ট এবং ভার্মিকম্পোস্ট সুপারিশ করা হয়। আপনি কত একর জমিতে সার দেওয়ার পরিকল্পনা করছেন?",
                "weather": "আপনার অবস্থানের জন্য লাইভ আবহাওয়া প্রতিবেদন এখানে:",
                "soil-health": "আপনার অবস্থানের উপর ভিত্তি করে, আপনার মাটি জৈব পদার্থ যোগ করলে উপকৃত হতে পারে। আপনি কি সম্প্রতি আপনার মাটির pH পরীক্ষা করেছেন?",
                "market-prices": "আপনি কোন ফসলের দাম পরীক্ষা করতে চান?",
                "default": "আমি দুঃখিত, আমি তা বুঝতে পারিনি। আপনি কি দয়া করে আবার বলতে পারেন অথবা শস্য নির্বাচন, কীটপতঙ্গ নিয়ন্ত্রণ, সার, আবহাওয়া বা বাজার মূল্য সম্পর্কে জিজ্ঞাসা করতে পারেন?",
                "options_title": "দ্রুত পরামর্শ বিকল্প",
                "crop-selection-query": "শস্য নির্বাচন পরামর্শ",
                "pest-control-query": "কীটপতঙ্গ নিয়ন্ত্রণ পরামর্শ",
                "fertilizer-query": "সার নির্দেশিকা",
                "weather-query": "আবহাওয়া পরামর্শ",
                "soil-health-query": "মাটির স্বাস্থ্য টিপস",
                "market-prices-query": "বাজার মূল্য",
                "soil-types": {
                    "question": "আপনার মাটির ধরণ কি? নিচের তালিকা থেকে একটি নির্বাচন করুন।",
                    "options": ["পলি মাটি", "কালো মাটি", "লাল মাটি", "ল্যাটেরাইট মাটি", "শুষ্ক মাটি", "বন মাটি"]
                },
                "crops_for_alluvial": "পলি মাটি সবচেয়ে উর্বর। আপনার অবস্থানের উপর ভিত্তি করে, আমি **গম**, **ধান**, **আখ**, এবং **পাট** এর মতো শস্য চাষের পরামর্শ দিই। আপনি কোন ফসলে আগ্রহী?",
                "crops_for_black": "কালো মাটি আর্দ্রতা ধরে রাখার জন্য দুর্দান্ত। আপনার অবস্থানে, **তুলা**, **সয়াবিন**, **জোয়ার**, এবং **গম** এর মতো শস্য উপযুক্ত। আপনি কি এর মধ্যে কোনটি বিবেচনা করছেন?",
                "crops_for_red": "আপনার লাল মাটির জন্য, যে শস্যগুলি ভালো হয় সেগুলি হল যা কম উর্বরতা সহ্য করতে পারে, যেমন **বাদাম**, **ডাল**, এবং **বাজরা**। কি এর মধ্যে কোনটি আপনার জন্য উপযুক্ত বলে মনে হয়?",
                "crops_for_laterite": "ল্যাটেরাইট মাটি প্রায়শই বাগান ফসলের জন্য ব্যবহৃত হয়। আমি **চা**, **কফি**, এবং এলাচ বা কাজুবাদামের মতো **মশলা** চাষের পরামর্শ দিই। আপনি কোনটি সম্পর্কে আরও জানতে চান?",
                "crops_for_arid": "শুষ্ক মাটি বালুকাময়। সঠিক সেচের সাথে, **বাজরা**, **যব**, এবং **খেজুর** এর মতো শস্য সফলভাবে চাষ করা যেতে পারে। আপনি কি এর মধ্যে কোনটিতে আগ্রহী?",
                "crops_for_forest": "বন মাটি হিউমাসে সমৃদ্ধ। আপনার অবস্থানে, আমি **ফল**, **চা**, এবং ঔষধি গাছ চাষের পরামর্শ দিই। আপনি এর মধ্যে কোনটি সম্পর্কে আরও জানতে চান?",
                "no_soil_type": "একটি নির্দিষ্ট শস্যের পরামর্শ পেতে দয়া করে প্রদত্ত বিকল্পগুলি থেকে একটি মাটির ধরণ নির্বাচন করুন।",
                "weather_report": "<b>{location} এ আবহাওয়া:</b><br>তাপমাত্রা: {temp}°C<br>অবস্থা: {description}<br>আর্দ্রতা: {humidity}%<br>বাতাসের গতি: {wind} m/s",
                "weather_error": "দুঃখিত, আমি এই মুহূর্তে আপনার অবস্থানের জন্য আবহাওয়া পেতে পারিনি। অনুগ্রহ করে পরে আবার চেষ্টা করুন।",
                "price_report": "<b>{district}, {state} এ {crop} এর জন্য লাইভ বাজার মূল্য:</b><br>মোডাল মূল্য: প্রতি কুইন্টাল ₹{modal}<br>সর্বনিম্ন মূল্য: প্রতি কুইন্টাল ₹{min}<br>সর্বোচ্চ মূল্য: প্রতি কুইন্টাল ₹{max}<br><i>(দাম {date}, {market} থেকে)</i>",
                "price_error": "দুঃখিত, আমি আপনার অঞ্চলে {crop} এর জন্য লাইভ বাজার মূল্য খুঁজে পাইনি। দাম উপলব্ধ নাও থাকতে পারে অথবা শস্যের নাম ভুল। অনুগ্রহ করে অন্য একটি শস্য চেষ্টা করুন অথবা পরে আবার দেখুন।",
                "ask_crop_price": "আপনি কোন ফসলের দাম পরীক্ষা করতে চান? (যেমন, ধান, গম, তুলা)",
                "price_unavailable": "আপনার অবস্থান বা নির্বাচিত ফসলের জন্য বাজার মূল্য উপলব্ধ নেই। অনুগ্রহ করে অন্য একটি অবস্থান বা ফসল চেষ্টা করুন।",
                "not_indian_location": "আমি দুঃখিত, কৃষি মিত্র বর্তমানে শুধুমাত্র ভারতের মধ্যে অবস্থিত অবস্থানের জন্য উপলব্ধ। আমরা আপনার অবস্থানের জন্য একটি রাজ্য বা জেলা খুঁজে পাইনি।"
            }
        };
        
        window.onload = function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        userLat = latitude;
                        userLon = longitude;
                        reverseGeocode(latitude, longitude);
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        showManualLocationInput("Could not detect your location. Please enter it manually.");
                    }
                );
            } else {
                showManualLocationInput("Geolocation is not supported by your browser. Please enter your location manually.");
            }
        };

        function reverseGeocode(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const address = data.address;
                    userState = address.state;
                    userDistrict = address.district || address.city || address.village;
                    
                    if (address.country_code !== 'in') {
                         document.getElementById('locationStatus').textContent = translations[userLanguage].not_indian_location;
                         return;
                    }
                    
                    if (userDistrict && userState) {
                        userLocation = `${userDistrict}, ${userState}`;
                        document.getElementById('locationStatus').textContent = `Location detected: ${userLocation}`;
                    } else {
                        userLocation = `Your Location`;
                        document.getElementById('locationStatus').textContent = "Couldn't pinpoint your district. Please enter it manually.";
                        document.getElementById('locationInputContainer').style.display = 'block';
                    }
                    document.getElementById('startButton').style.display = 'block';
                })
                .catch(error => {
                    console.error("Reverse geocoding error:", error);
                    showManualLocationInput("Could not determine your city. Please enter it manually.");
                });
        }

        function startChat() {
            const initialLanguage = document.getElementById('initialLanguage').value;
            const manualLocation = document.getElementById('initialLocation').value.trim();

            userLanguage = initialLanguage;
            if (manualLocation) {
                userLocation = manualLocation;
                const parts = manualLocation.split(',');
                if (parts.length > 1) {
                    userDistrict = parts[0].trim();
                    userState = parts[1].trim();
                } else {
                    userDistrict = manualLocation;
                }
            }

            if (!userDistrict || !userState) {
                alert("Please enter a valid location with District and State (e.g., Bhopal, Madhya Pradesh) to proceed.");
                return;
            }

            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'flex';

            document.getElementById('languageSelect').value = userLanguage;
            changeLanguage(false);
            isAwaitingSoilType = false;

            setTimeout(() => {
                const personalizedWelcome = translations[userLanguage].personalized_welcome.replace('{location}', userLocation);
                addMessage(`<p>${personalizedWelcome}</p>`, 'bot');
            }, 500);
        }

        function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (message === "") return;
            
            addMessage(`<p>${message}</p>`, 'user');

            if (isAwaitingSoilType) {
                setTimeout(() => {
                    const response = getCropsForSoilType(message, userLanguage);
                    addMessage(`<p>${response}</p>`, 'bot');
                    isAwaitingSoilType = false;
                }, 1000);
            } else if (isAwaitingCropName) {
                setTimeout(() => {
                    getMarketPrices(message);
                }, 1000);
            } else {
                setTimeout(() => {
                    getBotResponse(message, userLanguage);
                }, 1000);
            }
            
            userInput.value = "";
            userInput.focus();
        }

        function handleKeyPress(event) {
            if (event.keyCode === 13) {
                sendMessage();
            }
        }

        function addMessage(content, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender + '-message');
            messageDiv.innerHTML = content;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function getMarketOptionsHtml(lang) {
            const res = translations[lang] || translations["en"];
            const crops = ["Wheat", "Rice", "Cotton", "Maize", "Potato", "Onion"];
            
            let optionsHtml = '<div class="market-options">';
            crops.forEach(crop => {
                optionsHtml += `<div class="market-option" onclick="selectCropForPrice('${crop}')">${crop}</div>`;
            });
            optionsHtml += '</div>';

            return optionsHtml;
        }

        function selectCropForPrice(crop) {
            addMessage(`<p>${crop}</p>`, 'user');
            getMarketPrices(crop);
        }

        function getSoilTypeQuestionWithOptions(lang) {
            const res = translations[lang] || translations["en"];
            const questionText = res.soil_types.question;
            const options = res.soil_types.options;
            
            let optionsHtml = '<div class="soil-options">';
            options.forEach(option => {
                optionsHtml += `<div class="soil-option" onclick="sendSoilType('${option}')">${option}</div>`;
            });
            optionsHtml += '</div>';

            return `<p>${questionText}</p>${optionsHtml}`;
        }

        function getBotResponse(message, lang) {
            message = message.toLowerCase();
            const res = translations[lang] || translations["en"];
            let responseHtml = `<p>${res["default"]}</p>`;
            
            if (message.includes("help") || message.includes("advice") || message.includes("help me") || message.includes("can you help") || message.includes("how can you help") || message.includes("question") || message.includes("madad") || message.includes("salaah") || message.includes("salah") || message.includes("prashn") || message.includes("sahayam") || message.includes("salaha") || message.includes("prashna") || message.includes("sahajyo") || message.includes("poramorsh") || message.includes("proshno")) {
                responseHtml = getSoilTypeQuestionWithOptions(lang);
                isAwaitingSoilType = true;
            } else if (message.includes("hello") || message.includes("hi") || message.includes("namaste") || message.includes("నమస్కారం") || message.includes("নমস্কার") || message.includes("வணக்கம்")) {
                responseHtml = `<p>${res["greeting"]}</p>`;
            } else if (message.includes("crop") || message.includes("sowing") || message.includes("planting") || message.includes("falsal") || message.includes("budai") || message.includes("panta") || message.includes("bopon") || message.includes("ফসলের")) {
                responseHtml = getSoilTypeQuestionWithOptions(lang);
                isAwaitingSoilType = true;
            } else if (message.includes("pest") || message.includes("insect") || message.includes("disease") || message.includes("keet") || message.includes("rog") || message.includes("cheeda") || message.includes("pesticides") || message.includes("pokamakor") || message.includes("রোগ")) {
                responseHtml = `<p>${res["pest-control"]}</p>`;
            } else if (message.includes("fertilizer") || message.includes("compost") || message.includes("manure") || message.includes("urvarak") || message.includes("eruvulu") || message.includes("sar") || message.includes("jaibo sar")) {
                responseHtml = `<p>${res["fertilizer"]}</p>`;
            } else if (message.includes("weather") || message.includes("rain") || message.includes("monsoon") || message.includes("mausam") || message.includes("barish") || message.includes("vatavaranam") || message.includes("borsha") || message.includes("আবহাওয়া") || message.includes("bristi")) {
                if (userLat && userLon) {
                    getWeather(userLat, userLon, lang);
                } else {
                    addMessage(`<p>${res["weather_error"]}</p>`, 'bot');
                }
                return;
            } else if (message.includes("soil") || message.includes("health") || message.includes("ph") || message.includes("mitti") || message.includes("swasthya") || message.includes("nela") || message.includes("mati") || message.includes("shastho")) {
                responseHtml = `<p>${res["soil-health"]}</p>`;
            } else if (message.includes("price") || message.includes("market") || message.includes("sell") || message.includes("keemat") || message.includes("bazaar") || message.includes("dharalu") || message.includes("mullo")) {
                responseHtml = `<p>${res["ask_crop_price"]}</p>${getMarketOptionsHtml(lang)}`;
                isAwaitingCropName = true;
            }
            
            addMessage(responseHtml, 'bot');
        }

        async function getMarketPrices(cropName) {
            isAwaitingCropName = false;
            const res = translations[userLanguage] || translations["en"];

            if (!userState || !userDistrict) {
                addMessage(`<p>${res["price_unavailable"]}</p>`, 'bot');
                return;
            }

            const commodityMap = {
                "wheat": "Wheat",
                "rice": "Paddy(Dhan)",
                "cotton": "Cotton",
                "maize": "Maize",
                "potato": "Potato",
                "onion": "Onion",
                "sugarcane": "Sugarcane",
                "jute": "Jute",
                "soybean": "Soybean",
                "jowar": "Jowar",
                "groundnut": "Groundnut",
                "bajra": "Bajra",
                "barley": "Barley",
                "mustard": "Mustard",
                "arhar": "Arhar(Tur)"
            };

            const apiCropName = commodityMap[cropName.toLowerCase()] || cropName;

            const url = `https://api.data.gov.in/resource/9ef84268-d588-465a-a308-a864a43d0070?api-key=${OGD_API_KEY}&format=json&filters[state]=${userState}&filters[district]=${userDistrict}&filters[commodity]=${apiCropName}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Market price data not available.');
                }
                const data = await response.json();
                
                if (data.records && data.records.length > 0) {
                    const latestPrice = data.records[0];
                    const report = res["price_report"]
                        .replace('{crop}', latestPrice.commodity)
                        .replace('{district}', latestPrice.district)
                        .replace('{state}', latestPrice.state)
                        .replace('{modal}', latestPrice.modal_price)
                        .replace('{min}', latestPrice.min_price)
                        .replace('{max}', latestPrice.max_price)
                        .replace('{date}', latestPrice.arrival_date)
                        .replace('{market}', latestPrice.market);
                    addMessage(`<p>${report}</p>`, 'bot');
                } else {
                    addMessage(`<p>${res["price_error"].replace('{crop}', apiCropName)}</p>`, 'bot');
                }
            } catch (error) {
                console.error("Error fetching market data:", error);
                addMessage(`<p>${res["price_error"].replace('{crop}', apiCropName)}</p>`, 'bot');
            }
        }

        async function getWeather(lat, lon, lang) {
            if (!OPENWEATHER_API_KEY || OPENWEATHER_API_KEY === "YOUR_API_KEY_HERE") {
                addMessage(`<p>Please get an API key from OpenWeatherMap and replace 'YOUR_API_KEY_HERE' in the code.</p>`, 'bot');
                return;
            }
            const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=${lang}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Weather data not available.');
                }
                const data = await response.json();
                
                const temp = Math.round(data.main.temp);
                const humidity = data.main.humidity;
                const wind = data.wind.speed;
                const description = data.weather[0].description;
                
                const weatherReport = translations[lang]["weather_report"]
                    .replace('{location}', userLocation)
                    .replace('{temp}', temp)
                    .replace('{description}', description)
                    .replace('{humidity}', humidity)
                    .replace('{wind}', wind);
                
                addMessage(`<p>${translations[lang]["weather"]}</p>`, 'bot');
                addMessage(`<p>${weatherReport}</p>`, 'bot');
            } catch (error) {
                console.error("Error fetching weather data:", error);
                addMessage(`<p>${translations[lang]["weather_error"]}</p>`, 'bot');
            }
        }

        function sendSoilType(soilType) {
            addMessage(`<p>${soilType}</p>`, 'user');
            setTimeout(() => {
                const response = getCropsForSoilType(soilType, userLanguage);
                addMessage(`<p>${response}</p>`, 'bot');
                isAwaitingSoilType = false;
            }, 1000);
        }

        function getCropsForSoilType(soilType, lang) {
            const res = translations[lang] || translations["en"];
            const normalizedSoilType = soilType.toLowerCase().replace(/\s/g, '');
            let responseKey = '';

            switch(normalizedSoilType) {
                case 'alluvialsoil':
                case 'jalodhmitti':
                case 'ondrunela':
                case 'polimati':
                case 'vandhalmann':
                case 'வண்டல்மண்':
                    responseKey = 'crops_for_alluvial';
                    break;
                case 'blacksoil':
                case 'kalimitti':
                case 'nallanela':
                case 'kalomati':
                case 'karuppumann':
                case 'கறுப்புமண்':
                    responseKey = 'crops_for_black';
                    break;
                case 'redsoil':
                case 'lalmitti':
                case 'erranela':
                case 'lalmati':
                case 'semmann':
                case 'செம்மண்':
                    responseKey = 'crops_for_red';
                    break;
                case 'lateritesoil':
                case 'lateraitemitti':
                case 'lateraitenela':
                case 'lateraitmati':
                case 'letteraitmann':
                case 'லேட்டரைட்மண்':
                    responseKey = 'crops_for_laterite';
                    break;
                case 'aridsoil':
                case 'shushkmitti':
                case 'podinela':
                case 'shushkomati':
                case 'varatandmann':
                case 'வறண்டமண்':
                    responseKey = 'crops_for_arid';
                    break;
                case 'forestsoil':
                case 'vanmitti':
                case 'ataveenela':
                case 'banmati':
                case 'kattumann':
                case 'காட்டுமண்':
                    responseKey = 'crops_for_forest';
                    break;
                default:
                    return res["default"];
            }

            if (res[responseKey]) {
                return res[responseKey].replace('{location}', userLocation);
            } else {
                return res["default"];
            }
        }

        function selectOption(option) {
            const res = translations[userLanguage] || translations["en"];
            const optionTexts = {
                "crop-selection": res["crop-selection-query"],
                "pest-control": res["pest-control-query"],
                "fertilizer": res["fertilizer-query"],
                "weather": res["weather-query"],
                "soil-health": res["soil-health-query"],
                "market-prices": res["market-prices-query"]
            };
            
            addMessage(`<p>${optionTexts[option]}</p>`, 'user');
            
            setTimeout(() => {
                if (option === 'crop-selection') {
                    const responseHtml = getSoilTypeQuestionWithOptions(userLanguage);
                    addMessage(responseHtml, 'bot');
                    isAwaitingSoilType = true;
                } else if (option === 'weather') {
                    if (userLat && userLon) {
                        getWeather(userLat, userLon, userLanguage);
                    } else {
                        addMessage(`<p>${res["weather_error"]}</p>`, 'bot');
                    }
                } else if (option === 'market-prices') {
                    const responseHtml = `<p>${res["ask_crop_price"]}</p>${getMarketOptionsHtml(userLanguage)}`;
                    addMessage(responseHtml, 'bot');
                    isAwaitingCropName = true;
                } else {
                    const response = res[option];
                    addMessage(`<p>${response}</p>`, 'bot');
                }
            }, 1000);
        }

        function changeLanguage(updateChat = true) {
            const newLanguage = document.getElementById('languageSelect').value;
            userLanguage = newLanguage;
            const res = translations[userLanguage] || translations["en"];
            
            document.getElementById('optionsTitle').textContent = res["options_title"];
            
            document.querySelector('.option-card[onclick="selectOption(\'crop-selection\')"] .option-text').textContent = res["crop-selection-query"];
            document.querySelector('.option-card[onclick="selectOption(\'pest-control\')"] .option-text').textContent = res["pest-control-query"];
            document.querySelector('.option-card[onclick="selectOption(\'fertilizer\')"] .option-text').textContent = res["fertilizer-query"];
            document.querySelector('.option-card[onclick="selectOption(\'weather\')"] .option-text').textContent = res["weather-query"];
            document.querySelector('.option-card[onclick="selectOption(\'soil-health\')"] .option-text').textContent = res["soil-health-query"];
            document.querySelector('.option-card[onclick="selectOption(\'market-prices\')"] .option-text').textContent = res["market-prices-query"];
            
            if (updateChat) {
                addMessage(`<p>${res["personalized_welcome"].replace('{location}', userLocation)}</p>`, 'bot');
            }
        }

        function toggleVoiceInput() {
            if (!recognition) {
                alert("Voice input is not supported in your browser.");
                return;
            }

            if (isListening) {
                recognition.stop();
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('active');
                document.getElementById('voiceBtnText').textContent = 'Voice Input';
            } else {
                recognition.lang = userLanguage === 'en' ? 'en-IN' : (userLanguage === 'hi' ? 'hi-IN' : (userLanguage === 'ta' ? 'ta-IN' : (userLanguage === 'te' ? 'te-IN' : (userLanguage === 'bn' ? 'bn-IN' : 'en-IN'))));
                recognition.start();
                isListening = true;
                document.getElementById('voiceBtn').classList.add('active');
                document.getElementById('voiceBtnText').textContent = 'Listening...';
            }
        }
    </script>
</body>
</html>